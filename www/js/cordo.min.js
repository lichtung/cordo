/**
 * Created by lin on 6/21/17.
 */
var cordo=(function(){var currentDownload=null;var currentUpload=null;var fetchFileTransferError=function(error){var message="unknown error";switch(error.code){case FileTransferError.FILE_NOT_FOUND_ERR:message="file not found";break;case FileTransferError.INVALID_URL_ERR:message="invalid url";break;case FileTransferError.CONNECTION_ERR:message="connect failed";break;case FileTransferError.ABORT_ERR:message="abort";break;case FileTransferError.NOT_MODIFIED_ERR:message="not modified";break}return message};var getFileEntryFailedMessage=function(error){var message="unknown error";switch(error.code){case FileError.NOT_FOUND_ERR:message='not found';break;case FileError.SECURITY_ERR:message='security';break;case FileError.ABORT_ERR:message='abort';break;case FileError.ENCODING_ERR:message='bad encoding';break;case FileError.NO_MODIFICATION_ALLOWED_ERR:message="no modification allowed";break;case FileError.INVALID_STATE_ERR:message="invalid state";break;case FileError.SYNTAX_ERR:message="SYNTAX error";break;case FileError.INVALID_MODIFICATION_ERR:message="invalid modification";break;case FileError.QUOTA_EXCEEDED_ERR:message="quota exceeded";break;case FileError.TYPE_MISMATCH_ERR:message="type mismatch";break;case FileError.PATH_EXISTS_ERR:message="path exists";break}return message};var iterate=function(obj,call){var result;for(var key in obj){if(!obj.hasOwnProperty(key))continue;result=call(obj[key],key,meta);if(result==='break')break;if(result==='continue')continue;if(result!==undefined)return result}};var writeFile=function(filename,content,callback,type){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(fs){fs.root.getFile(filename,{create:true,exclusive:false},function(fileEntry){fileEntry.createWriter(function(fileWriter){if(!(content instanceof Blob)){content=new Blob([content],{type:type||'text/plain'})}fileWriter.write(content);callback(true,fileEntry)},function(error){callback(false,{code:error.code,message:getFileEntryFailedMessage(error)})})})})};var readFileEntry=function(fileEntry,callback){fileEntry.file(function(file){var reader=new FileReader();reader.onloadend=function(){callback(true,this.result,fileEntry)};reader.readAsText(file)})};var readFile=function(filename,callback){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(fs){fs.root.getFile(filename,{false:true,exclusive:false},function(fileEntry){readFileEntry(fileEntry,callback)},function(error){callback(false,{code:error.code,message:getFileEntryFailedMessage(error)})})})};var contact_fields=["id","displayName","name","nickname","phoneNumbers","emails","addresses","ims","organizations","birthday","note","photos","categories","urls"];return{storage:{write:writeFile,read:readFile},getGeolocation:function(callback){navigator.geolocation.getCurrentPosition(function(position){callback(true,position.coords)},function(error){var message="unknown error";switch(error.code){case PositionError.PERMISSION_DENIED:message='permission denied';break;case PositionError.POSITION_UNAVAILABLE:message='failed to get position(no signal)';break;case PositionError.TIMEOUT:message='get position timeout';break}callback(false,{code:error.code,message:message})},{maximumAge:3000,timeout:5000,enableHighAccuracy:true})},getPicture:function(callback,opts,full){var options={quality:50,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.CAMERA,allowEdit:true,encodingType:Camera.EncodingType.JPEG,targetWidth:500,targetHeight:500,mediaType:Camera.MediaType.PICTURE,correctOrientation:true,saveToPhotoAlbum:false,cameraDirection:Camera.Direction.BACK};opts&&iterate(opts,function(val,key){options[key]=val});navigator.camera.getPicture(function(imageData){if(full){if(options.encodingType===Camera.EncodingType.JPEG){imageData="data:image/jpeg;base64,"+imageData}else if(options.encodingType===Camera.EncodingType.PNG){imageData="data:image/png;base64,"+imageData}else{}}callback(true,imageData)},function(message){callback(false,{code:0,message:message})},options)},iterateContacts:function(iterator,endcall,fils){navigator.contacts.find(fils||contact_fields,function(contacts){for(var x in contacts){iterator(contacts[x])}endcall(null)},function(error){var message="unknown";switch(error.code){case ContactError.INVALID_ARGUMENT_ERROR:message="invalid argument";break;case ContactError.TIMEOUT_ERROR:message="timeout";break;case ContactError.PENDING_OPERATION_ERROR:message="pending operation failed";break;case ContactError.IO_ERROR:message="IO error";break;case ContactError.NOT_SUPPORTED_ERROR:message="not supported";break;case ContactError.PERMISSION_DENIED_ERROR:message="permission denied";break;case ContactError.UNKNOWN_ERROR:default:}endcall({code:error.code,message:message})})},alert:function(message,buttonPressCallback,title){navigator.notification.alert(message,buttonPressCallback||function(){},title||"提示","确定")},beep:function(){navigator.notification.beep(1)},getDeviceModel:function(){return device.model},getDevicePlatform:function(){return device.platform},getDevicePlatformVersion:function(){return device.version},isAndroid:function(){return"Android"===device.platform},isIOS:function(){return"iOS"===device.platform},getUUID:function(){return device.uuid},scan:function(callback,opts){var options={preferFrontCamera:false,showFlipCameraButton:false,showTorchButton:false,torchOn:false,prompt:"Place a barcode inside the scan area",resultDisplayDuration:500,orientation:"portrait",disableAnimations:true,disableSuccessBeep:true};opts&&iterate(opts,function(val,key){options[key]=val});if("barcodeScanner"in cordova.plugins){cordova.plugins.barcodeScanner.scan(function(res){callback(true,{"text":res.text,"cancel":res.cancelled,"format":res.format})},function(error){callback(false,error)},options)}},abortUpload:function(){currentUpload&&currentUpload.abort()},abortDownload:function(){currentDownload&&currentDownload.abort()},upload:function(filename,uri,callback,params){window.requestFileSystem(LocalFileSystem.PERSISTENT,0,function(fs){fs.root.getFile(filename,{create:true,exclusive:false},function(fileEntry){var fileURL=fileEntry.toURL();var options=new FileUploadOptions();options.fileKey="file";options.fileName=fileURL.substr(fileURL.lastIndexOf('/')+1);options.mimeType="text/plain";options.params=params;currentUpload=new FileTransfer();currentUpload.upload(fileURL,encodeURI(uri),function(res){callback(true,res);currentUpload=null},function(error){callback(true,error.code);currentUpload=null},options)},function(error){callback(false,{code:error.code,message:fetchFileTransferError(error)})})})},download:function(sourceUri,saveName,callback,headers){window.requestFileSystem(window.PERSISTENT,0,function(fs){fs.root.getFile(saveName,{create:true,exclusive:false},function(fileEntry){currentDownload=new FileTransfer();currentDownload.download(encodeURI(sourceUri),fileEntry.toURL(),function(entry){callback(true,entry);currentDownload=null},function(error){callback(false,{code:error.code,message:fetchFileTransferError(error)});currentDownload=null},false,{headers:headers||{}})})})},getManufacturer:function(){return device.manufacturer},isVirtual:function(){return device.isVirtual},initialize:function(deviceready){document.addEventListener('deviceready',deviceready,false);return cordo},log:function(message){readFile("log.txt",function(res,content){if(res){writeFile("log.txt",content+"\n"+message,function(res){if(!res)cordo.alert("log failed")},"")}else{cordo.alert("log failed")}})}}})();
